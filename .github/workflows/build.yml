name: build
on:
  pull_request:
    types: [opened, synchronize]
jobs:
  build-vegafusion-server-linux-64:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build vegafusion-server (Mac/Linux)
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: -p vegafusion-server --release --features=protobuf-src
      - name: zip executable
        uses: papeloto/action-zip@v1
        with:
          files: target/release/vegafusion-server
          dest: vegafusion-server-linux-64.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-server
          path: |
            vegafusion-server-*

  build-vegafusion-server-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Download arm64 toolchain
        run: |
          rustup target add aarch64-unknown-linux-gnu
      - name: Download gcc for cross compilation
        run: |
          sudo apt-get update
          sudo apt-get install gcc-aarch64-linux-gnu
      - name: Build vegafusion-server (Mac/Linux)
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: -p vegafusion-server --release --features=protobuf-src --target=aarch64-unknown-linux-gnu
      - name: zip executable
        uses: papeloto/action-zip@v1
        with:
          files: target/aarch64-unknown-linux-gnu/release/vegafusion-server
          dest: vegafusion-server-linux-arm64.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-server
          path: |
            vegafusion-server-*

  build-vegafusion-server-win-64:
    runs-on: windows-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install protoc on Window
        run: |
          choco install --yes protoc
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build vegafusion-server (Windows)
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: -p vegafusion-server --release
      - name: zip executable
        uses: papeloto/action-zip@v1
        with:
          files: target/release/vegafusion-server.exe
          dest: vegafusion-server-win-64.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-server
          path: |
            vegafusion-server-*

  build-vegafusion-server-osx-64:
    runs-on: macos-11
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build vegafusion-server
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: -p vegafusion-server --release --features=protobuf-src
      - name: zip executable
        uses: papeloto/action-zip@v1
        with:
          files: target/release/vegafusion-server
          dest: vegafusion-server-osx-64.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-server
          path: |
            vegafusion-server-*

  build-vegafusion-server-osx-arm64:
    runs-on: macos-11
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Download Apple Silicon toolchain
        run: |
          rustup target add aarch64-apple-darwin
      - name: Build vegafusion-server
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: -p vegafusion-server --release --target aarch64-apple-darwin --features=protobuf-src
      - name: zip executable (Apple silicon)
        uses: papeloto/action-zip@v1
        with:
          files: target/aarch64-apple-darwin/release/vegafusion-server
          dest: vegafusion-server-osx-arm64.zip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-server
          path: |
            vegafusion-server-*

  build-vegafusion-python-embed-linux-64:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build wheels (Linux)
        uses: messense/maturin-action@v1
        with:
          command: build
          manylinux: 2014
          rust-toolchain: stable
          args: --release -m vegafusion-python-embed/Cargo.toml --features=protobuf-src --strip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-python-embed-wheels
          path: |
            target/wheels/*.tar.gz
            target/wheels/*.whl

  build-vegafusion-python-embed-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Download arm64 toolchain
        run: |
          rustup target add aarch64-unknown-linux-gnu
      - name: Build arm64 wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          manylinux: 2014
          rust-toolchain: stable
          args: --release -m vegafusion-python-embed/Cargo.toml --features=protobuf-src --strip --target aarch64-unknown-linux-gnu
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-python-embed-wheels
          path: |
            target/wheels/*.tar.gz
            target/wheels/*.whl

  build-vegafusion-python-embed-win-64:
    runs-on: windows-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install protoc
        run: |
          choco install --yes protoc
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          architecture: 'x64'
          python-version: '3.10'
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          manylinux: 2014
          rust-toolchain: stable
          args: --release -m vegafusion-python-embed/Cargo.toml --strip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-python-embed-wheels
          path: |
            target/wheels/*.tar.gz
            target/wheels/*.whl

  build-vegafusion-python-embed-osx-64:
    runs-on: macos-11
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install protoc
        run: |
          brew install protobuf
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Build wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          rust-toolchain: stable
          args: --release -m vegafusion-python-embed/Cargo.toml --strip
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-python-embed-wheels
          path: |
            target/wheels/*.tar.gz
            target/wheels/*.whl

  build-vegafusion-python-embed-osx-arm64:
    runs-on: macos-11
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install protoc
        run: |
          brew install protobuf
      - name: Install latest stable Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: True
      - name: Download Apple Silicon toolchain
        run: |
          rustup target add aarch64-apple-darwin
      - name: Build Apple Silicon wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          rust-toolchain: stable
          args: --release -m vegafusion-python-embed/Cargo.toml --strip --target aarch64-apple-darwin
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: vegafusion-python-embed-wheels
          path: |
            target/wheels/*.tar.gz
            target/wheels/*.whl
